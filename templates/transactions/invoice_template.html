<div x-cloak x-data="priceCalculator" class="rounded-lg py-1 min-h-full">
    <div class="flex items-center">
        <div class="px-2 py-1 inline-flex items-center">
            {% include "core/partials/svgs/document.html" %}
            <span class="ml-2 font-serif">DEVIS CLIENT Nº</span>
            <span class="font-serif text-xl font-semibold" id="displayNumero"></span>
            <span id="displayClient"
                  class="ml-2 font-serif text-2xl text-blue-600 font-semibold">Client</span>
        </div>
    </div>
    <div class="m-2 flex justify-between">
        <div class="m-2 flex items-center gap-2">
            <!-- This example requires Tailwind CSS v2.0+ -->
            <div>
                <div>
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                            id="menu-button"
                            aria-expanded="true"
                            aria-haspopup="true">
                        Transformer
                        <!-- Heroicon name: mini/chevron-down -->
                        <svg class="-mr-1 ml-2 h-5 w-5"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            <div>
                <div>
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                            id="menu-button"
                            aria-expanded="true"
                            aria-haspopup="true">
                        Valider
                        <!-- Heroicon name: mini/chevron-down -->
                    </button>
                </div>
            </div>
            <div>
                <div>
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                            id="menu-button"
                            aria-expanded="true"
                            aria-haspopup="true">
                        Vérouiller
                        <!-- Heroicon name: mini/chevron-down -->
                    </button>
                </div>
            </div>
        </div>
        <div class="m-2 flex items-center gap-2">
            <!-- This example requires Tailwind CSS v2.0+ -->
            <div>
                <div>
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                            id="menu-button"
                            aria-expanded="true"
                            aria-haspopup="true">
                        Modifier
                        <!-- Heroicon name: mini/chevron-down -->
                        <svg class="-mr-1 ml-2 h-5 w-5"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            <div>
                <div>
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                            id="menu-button"
                            aria-expanded="true"
                            aria-haspopup="true">
                        Supprimer
                        <!-- Heroicon name: mini/chevron-down -->
                    </button>
                </div>
            </div>
            <div>
                <div>
                    <button type="button"
                            class="inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-100"
                            id="menu-button"
                            aria-expanded="true"
                            aria-haspopup="true">
                        Envoyer par mail
                        <!-- Heroicon name: mini/chevron-down -->
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div x-data="{ modalOneOpen:false , modalTwoOpen:false }"
         class="bg-white shadow-xl m-2 p-2 ">
        <div>
            <div x-show="modalOneOpen"
                 @click.outside="modalOneOpen = false"
                 @keydown.window.escape="modalOneOpen = false"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-300"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">{% include "transactions/partials/overall_info_form.html" %}</div>
            <div x-show="modalTwoOpen"
                 @click.outside="modalTwoOpen = false"
                 @keydown.window.escape="modalTwoOpen = false"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-300"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">{% include "transactions/partials/sale_info_form.html" %}</div>
        </div>
        <button class="bg-gray-400 m-2 py-1 px-4 font-bold text-white rounded-l-none rounded-md hover:bg-gray-500">
            DRAFT
        </button>
        <div class="border-t border-gray-200"></div>
        <div class="m-2 grid grid-cols-3 gap-2 p-2">
            <div class="col-span-1 flex flex-col divide-y-2 p-2 gap-2 border-b border-gray-200">
                <div class="pt-1 flex justify-between w-full">
                    <span>Statut</span>
                    <button class="bg-blue-500 hover:bg-blue-600 rounded-lg px-2 py-1 text-xs text-white border-b border-gray-200">
                        En Cours
                    </button>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span>Date</span>
                    <span id="displayDate"></span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span>Echeance</span>
                    <span id="displayEcheance"></span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span>Suivi Par</span>
                    <span id="displaySuiviPar"></span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span>Lié</span>
                    <button class="bg-yellow-400 text-yellow-800 py-1 rounded-md px-2 text-xs hover:bg-yellow-500 font-bold">Non</button>
                </div>
                <div class=" pt-2 flex  items-center justify-center">
                    <button @click="modalOneOpen=true"
                            class="flex hover:underline decoration-blue-800"
                            type="button">
                        {% include "core/partials/svgs/edit_button.html" %}
                        <span class="text-xs text-[#3c7aaa] font-bold">Modifier les informations générales</span>
                    </button>
                </div>
            </div>
            <div class="col-span-2 flex flex-col divide-y-2 p-2 gap-2 border-b border-gray-200">
                <div class="pt-1 flex  justify-between w-full">
                    <span class="text-gray-400">Adresse de livraison</span>
                    <span id="adresse" class="text-gray-400">Adresse de livraison</span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span class="text-gray-400">Moyen de paiement</span>
                    <span id="payment" class="text-gray-400">Virement</span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span class="text-gray-400">Commission</span>
                    <span id="commission" class="text-gray-400">0.00 %</span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span class="text-gray-400">Commercial</span>
                    <span id="commercial" class="text-gray-400">Aucun</span>
                </div>
                <div class="pt-1 flex justify-between w-full">
                    <span class="text-gray-400">Note</span>
                    <span id="note" class="text-gray-400">Aucun</span>
                </div>
                <div class=" pt-2 flex items-center justify-center">
                    <button @click="modalTwoOpen=true"
                            class="flex hover:underline decoration-blue-800"
                            type="button">
                        {% include "core/partials/svgs/edit_button.html" %}
                        <span class="text-xs text-[#3c7aaa] font-bold">Modifier les conditions de vente</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex justify-between mx-2">
            <div x-data="{showSuggestion : true }"  id="search-box">
                <div class="h-8 mt-1 flex rounded-md shadow-sm">
                    <input x-on:mouseenter="timeout = setTimeout(() => { showSuggestion = true }, 800)"
                           class="block w-full flex-1 rounded-none rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                           name="designation"
                           type="text"
                           placeholder="Recherchez un Produit dans la base de donnée..."
                           hx-post="{% url 'transactions:get_product' %}"
                           hx-target="#results"
                           hx-trigger="keyup changed delay:1s"
                           id="myUniqueTrigger">
                    <span class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-3 text-sm text-gray-500">
                        <svg class="h-5 w-5"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 20 20"
                             fill="currentColor"
                             aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                    </span>
                </div>
                <div id="results" class="absolute z-40"></div>
            </div>
            <div class="flex justify-center items-center gap-1">
                <button type="button"
                        class="group bg-green-400 inline-flex justify-center rounded-md px-3 py-2 text-sm font-medium hover:text-gray-700 shadow-sm hover:bg-green-500 text-white "
                        id="menu-button"
                        aria-expanded="true"
                        aria-haspopup="true">
                    {% include "core/partials/svgs/add_button.html" %}
                    Ajouter
                </button>
                <button type="button"
                        class="inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-offset-1 focus:ring-offset-gray-100"
                        id="menu-button"
                        aria-expanded="true"
                        aria-haspopup="true">
                    Importer
                    <!-- Heroicon name: mini/chevron-down -->
                    <svg class="-mr-1 ml-2 h-5 w-5"
                         xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 20 20"
                         fill="currentColor"
                         aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="my-2 align-middle inline-block min-w-full shadow overflow-x-auto  to-white pt-1 rounded-bl-lg rounded-br-lg">
            <table class="min-w-full" id="mainTable">
                <thead class="bg-gradient-to-b from-cyan-100">
                    <tr>
                        <th class="px-4 py-2 border-b-2 border-gray-300 text-left leading-4 text-gray-500 tracking-wider">REF</th>
                        <th class="px-4 py-2 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider">
                            Désignation
                        </th>
                        <th class="px-4 py-1 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider">Qté</th>
                        <th class="px-4 py-1 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider">Prix HT</th>
                        <th class="px-4 py-1 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider">Prix TTC</th>
                        <th class="px-4 py-1 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider">Total HT</th>
                        <th class="px-4 py-1 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider">
                            Total TTC
                        </th>
                        <th class="px-4 py-1 border-b-2 border-gray-300 text-left text-sm leading-4 text-gray-500 tracking-wider"></th>
                    </tr>
                </thead>
                <tbody id="invoice-listing" class="bg-white">
                    {% comment %} {% include "transactions/partials/invoice_row.html" %} {% endcomment %}
                </tbody>
            </table>
        </div>
        <div class="border-t border-gray-200"></div>
        <div class=" my-5 flex flex-col justify-end w-full">
            <div class="font-bold text-sm px-5 py-2 flex justify-between w-1/3 ml-auto">
                <span>Total HT</span>
                <span class="total-ht">0.00 MAD</span>
            </div>
            <div class="font-bold text-sm px-5 py-2 flex justify-between w-1/3 ml-auto">
                <span>Total TVA</span>
                <span class="total-tva">0.00 MAD</span>
            </div>
            <div class=" my-2 px-5 py-2 bg-gray-200 font-bold text-sm flex justify-between w-1/3 ml-auto">
                <span>Total TTC</span>
                <span class="total-ttc">0.00 MAD</span>
            </div>
            <div class="border-t border-gray-200"></div>
        </div>
        {{ form_three.as_p }}
        <div class="mt-2 flex justify-end">
            <button type="submit"
                    onclick="submitForms()"
                    class="px-4 py-2 bg-indigo-500 rounded-md font-bold text-white">Enregister</button>
        </div>
    </div>
    <script>
       document.addEventListener('alpine:init', () => {
        Alpine.data('priceCalculator', () => ({
        init() {
            console.log(this);
            this.calculateTotals();
            document.body.addEventListener('htmx:afterSwap', (event) => {
                if (event.detail.target.id === 'invoice-listing') {
                    this.calculateTotals();
                }
            });
            document.addEventListener('removed', () => {
                console.log("Hallo MDF");
                this.calculateTotals();
            });
           
        },
        calculateTotals() {
            this.$nextTick(() => {
                let grandTotalHT = 0;
                let grandTotalTTC = 0;

                document.querySelectorAll('#invoice-listing .myUniqueClass').forEach((row) => {
                    const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                    const price_ht = parseFloat(row.querySelector('.price_ht').value) || 0;
                    const price_ttc = parseFloat(row.querySelector('.price_ttc').value) || 0;
                    
                    const total_ht = quantity * price_ht;
                    const total_ttc = quantity * price_ttc;

                    grandTotalHT += total_ht;
                    grandTotalTTC += total_ttc;
        
                    row.querySelector('.total_ht').value = total_ht.toFixed(2);
                    row.querySelector('.total_ttc').value = total_ttc.toFixed(2);
                });

                // Update the grand totals in the summary divs
                document.querySelector('.total-ht').textContent = grandTotalHT.toFixed(2) + ' MAD';
                document.querySelector('.total-ttc').textContent = grandTotalTTC.toFixed(2) + ' MAD';

                // Assuming you have a way to calculate the total TVA from the HT or TTC values
                // Update this line with the correct calculation for the total TVA
                const totalTVA = this.calculateTotalTVA(grandTotalHT, grandTotalTTC);
                document.querySelector('.total-tva').textContent = totalTVA.toFixed(2) + ' MAD';
            });
        },
        calculateTotalTVA(totalHT, totalTTC) {
            // Implement the TVA calculation logic here
            // This is a placeholder, update it with your actual tax calculation
            return totalTTC - totalHT;
        }
            }));
        });
        
    </script>
</div>
